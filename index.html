<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <title>Chronosphere Focus</title>
    <link rel="manifest" href="/manifest.json">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .light-mode {
            background-color: #ffffff;
            color: #000000;
        }

        .dark-mode {
            background-color: #000000;
            color: #a0aec0;
        }

        .progress-ring {
            transform: rotate(-90deg);
            transition: stroke 0.3s, opacity 0.5s ease;
        }

        .timer-active .progress-ring {
            opacity: 0.15;
        }

        .timer-active #app {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .light-mode .progress-ring__circle {
            stroke: #3b82f6;
        }

        .dark-mode .progress-ring__circle {
            stroke: #8a8e96;
        }

        .light-mode #status, .light-mode h1 {
            color: #000000;
        }

        .dark-mode #status, .dark-mode h1 {
            color: #a0aec0;
        }

        .settings-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 90%;
            width: 300px;
        }

        .light-mode .settings-popup {
            background-color: #f3f4f6;
            color: #000000;
        }

        .dark-mode .settings-popup {
            background-color: #1a202c;
            color: #a0aec0;
        }

        .settings-popup input[type="number"],
        .settings-popup select {
            background-color: transparent;
            border: 1px solid currentColor;
            color: inherit;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 light-mode">
    <div id="app" class="text-center p-8 rounded-lg transition-all duration-300">
        <h1 class="text-2xl font-semibold mb-6 opacity-80">Chronosphere Focus</h1>
        <div class="mb-8 relative">
            <svg class="progress-ring" width="250" height="250">
                <circle class="progress-ring__circle" stroke-width="4" fill="transparent" r="116" cx="125" cy="125"/>
            </svg>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-lg font-medium opacity-70" id="status" aria-live="polite">Ready</div>
        </div>
        <div id="instructions" class="text-sm opacity-60 mt-4">
            Double tap: Start/Pause<br>
            Long press: Open settings
        </div>
    </div>

    <div id="settingsPopup" class="settings-popup">
        <h2 class="text-xl font-semibold mb-4">Settings</h2>
        <div class="mb-4">
            <label class="block mb-2">Theme:</label>
            <select id="themeSelect" class="w-full p-2 rounded">
                <option value="light">Light</option>
                <option value="dark">Dark</option>
                <option value="system">System</option>
            </select>
        </div>
        <div class="mb-4">
            <label class="block mb-2">Focus Duration (minutes):</label>
            <input type="number" id="focusDuration" class="w-full p-2 rounded" min="1" max="120">
        </div>
        <div class="mb-4">
            <label class="block mb-2">Break Duration (minutes):</label>
            <input type="number" id="breakDuration" class="w-full p-2 rounded" min="1" max="30">
        </div>
        <button id="saveSettings" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save</button>
        <button id="closeSettings" class="ml-2 bg-gray-300 text-gray-800 px-4 py-2 rounded hover:bg-gray-400">Close</button>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(async (registration) => {
      console.log('Service Worker registered with scope:', registration.scope);

      if ('periodicSync' in registration) {
        try {
          const status = await navigator.permissions.query({
            name: 'periodic-background-sync',
          });
          if (status.state === 'granted') {
            await registration.periodicSync.register('update-cache', {
              minInterval: 24 * 60 * 60 * 1000 // Sync once a day
            });
            console.log('Periodic Sync registered');
          }
        } catch (error) {
          console.error('Periodic Sync registration failed:', error);
        }
      }
    })
    .catch((error) => {
      console.error('Service Worker registration failed:', error);
    });
}
        const statusDisplay = document.getElementById('status');
        const circle = document.querySelector('.progress-ring__circle');
        const radius = circle.r.baseVal.value;
        const circumference = radius * 2 * Math.PI;
        const sound = new Howl({ src: ['/music/noti.mp3'] });

        circle.style.strokeDasharray = `${circumference} ${circumference}`;
        circle.style.strokeDashoffset = circumference;

        let isWorking = true;
        let timer;
        let timeLeft = 25 * 60;
        let taps = 0;
        let lastTap = 0;
        let longPressTimer;
        let audioPlayingTimer;

        // Settings
        let focusDuration = 25;
        let breakDuration = 5;

        function setProgress(percent) {
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }

        function updateTimer() {
            timeLeft--;
            setProgress((timeLeft / (isWorking ? focusDuration * 60 : breakDuration * 60)) * 100);
            if (timeLeft <= 0) {
                isWorking = !isWorking;
                timeLeft = isWorking ? focusDuration * 60 : breakDuration * 60;
                statusDisplay.textContent = isWorking ? 'Focusing' : 'Taking a Break';
                playNotificationSound();
            } else {
                statusDisplay.textContent = isWorking ? 'Focusing' : 'Taking a Break';
            }
        }

        function playNotificationSound() {
            sound.play();
            audioPlayingTimer = setTimeout(() => {
                sound.stop();
                audioPlayingTimer = null;
            }, 20000);
        }

        function startPauseTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
                statusDisplay.textContent = 'Paused';
                document.body.classList.remove('timer-active');
            } else {
                timer = setInterval(updateTimer, 1000);
                statusDisplay.textContent = isWorking ? 'Focusing' : 'Taking a Break';
                document.body.classList.add('timer-active');
            }
        }

        function openSettings() {
            document.getElementById('settingsPopup').style.display = 'block';
            document.getElementById('focusDuration').value = focusDuration;
            document.getElementById('breakDuration').value = breakDuration;
        }

        document.body.addEventListener('touchstart', (e) => {
            longPressTimer = setTimeout(openSettings, 1000);
        });

        document.body.addEventListener('touchend', (e) => {
            clearTimeout(longPressTimer);
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 500 && tapLength > 0) {
                taps++;
                if (taps === 2) {
                    if (audioPlayingTimer) {
                        clearTimeout(audioPlayingTimer);
                        sound.stop();
                        audioPlayingTimer = null;
                    } else {
                        startPauseTimer();
                    }
                    taps = 0;
                    return;
                }
            } else {
                taps = 1;
            }
            lastTap = currentTime;
        });

        document.getElementById('saveSettings').addEventListener('click', () => {
            focusDuration = parseInt(document.getElementById('focusDuration').value);
            breakDuration = parseInt(document.getElementById('breakDuration').value);
            const theme = document.getElementById('themeSelect').value;
            setTheme(theme);
            document.getElementById('settingsPopup').style.display = 'none';
            timeLeft = isWorking ? focusDuration * 60 : breakDuration * 60;
            setProgress(100);
        });

        document.getElementById('closeSettings').addEventListener('click', () => {
            document.getElementById('settingsPopup').style.display = 'none';
        });

        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('light-mode');
            } else if (theme === 'dark') {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
            } else {
                // System theme
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.classList.remove('light-mode');
                    document.body.classList.add('dark-mode');
                } else {
                    document.body.classList.remove('dark-mode');
                    document.body.classList.add('light-mode');
                }
            }
        }

        // Initialize theme
        setTheme('system');

        if ("Notification" in window) {
            Notification.requestPermission();
        }
    </script>
</body>
</html>
